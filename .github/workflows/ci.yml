name: CI

on:
  push:
  pull_request:

jobs:
  windows-pytest:
    runs-on: windows-latest
    steps:
      - name: Checkout (no submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install pytest
        run: python -m pip install -U pip pytest

      - name: Configure auth + fetch submodules
        shell: pwsh
        env:
          SWENG_SUBMODULE_TOKEN: ${{ secrets.SWENG_SUBMODULE_TOKEN }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          $tok = $env:SWENG_SUBMODULE_TOKEN
          if ([string]::IsNullOrWhiteSpace($tok)) { $tok = $env:GITHUB_TOKEN }

          if ([string]::IsNullOrWhiteSpace($tok)) {
            throw "FAILURE DETECTED: no token available for submodule access (set repo secret SWENG_SUBMODULE_TOKEN)"
          }

          git config --global "http.https://github.com/.extraheader" ("AUTHORIZATION: basic " + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(("x-access-token:" + $tok))))

          git submodule sync --recursive
          git submodule update --init --force --recursive

      - name: Pytest (explicit)
        run: python -m pytest -q

      - name: Publish harness (CI)
        shell: pwsh
        env:
          SWENG_PUBLISH_SKIP_PYTEST: "1"
          SWENG_CI_PACK_SKIP_PYTEST: "1"
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File "tools/publish_gated_ci.ps1" -Intent tag
